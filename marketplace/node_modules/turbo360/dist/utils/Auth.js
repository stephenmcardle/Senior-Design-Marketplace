var Promise=require("bluebird"),superagent=require("superagent"),IndexDB=require("./IndexDB"),helper=require("./Helper"),Auth=function(e){var r=e;return{login:function(n){return new Promise(function(t,i){return 0==helper.validateSiteId(e)?void i(new Error("Please Set Your TURBO_APP_ID")):null==n?void i(new Error("Post parameters required.")):(n.site=r.site_id,void superagent.post(r.base_url+"/auth/login").send(n).set("Accept","application/json").end(function(e,n){if(e)return void i(e);var o=n.body;if("success"!=o.confirmation){var u=o.message||"Login Failed";return void i(new Error(u))}var d=o.user||o.result;if("undefined"==typeof window)return void t(d);var s=IndexDB(r);if(null==s)return void t(d);s.dbTransaction(function(e,n){if(e)return void i(e);n.put({id:r.site_id,token:o.token}),t(d)})}))})},logout:function(){return new Promise(function(n,t){if(0==helper.validateSiteId(e))return void t(new Error("Please Set Your TURBO_APP_ID"));if("undefined"==typeof window)return void n(null);var i=IndexDB(r);if(null==i)return void n(null);i.dbTransaction(function(e,i){if(e)return void t(e);var o=i.delete(r.site_id);o.onsuccess=function(){console.log("Token Removed"),n(null)},o.onerror=function(e){t(e.target)}})})},currentUser:function(){return new Promise(function(e,n){if("undefined"==typeof window)return void e(null);var t=IndexDB(r);if(null==t)return void e(null);t.dbTransaction(function(t,i){if(t)return void n(t);var o=i.get(r.site_id);o.onsuccess=function(){if(null==o.result)return void n(new Error("Not Logged In"));superagent.get(r.base_url+"/auth/currentuser").query(null).set("Accept","application/json").set("turbo-token",o.result.token).end(function(r,t){if(r)return void n(r);if("success"!=t.body.confirmation)return void n(new Error(t.body.message));var i=t.body.user||t.body.result;e(i)})},o.onerror=function(e){n(e.target)}})})},createUser:function(n){return new Promise(function(t,i){return 0==helper.validateSiteId(e)?void i(new Error("Please Set Your TURBO_APP_ID")):null==n?void i(new Error("Post parameters required.")):(n.site=r.site_id,void superagent.post(r.base_url+"/auth/createuser").send(n).set("Accept","application/json").end(function(e,n){if(e)return void i(e);var o=n.body;if("success"!=o.confirmation){var u=o.message||"Registration Failed";return void i(new Error(u))}var d=o.user||o.result;if("undefined"==typeof window)return console.log("Window undefined!"),void t(d);var s=IndexDB(r);if(null==s)return void t(d);s.dbTransaction(function(e,n){if(e)return void i(e);n.put({id:r.site_id,token:o.token}),t(d)})}))})},fetchUser:function(n){return new Promise(function(t,i){if(0==helper.validateSiteId(e))return void i(new Error("Please Set Your TURBO_APP_ID"));superagent.get(r.base_url+"/api/user/"+n).query(null).set(helper.standardHeaders(e)).end(function(e,r){if(e)return void i(e);if("success"!=r.body.confirmation)return void i(new Error(r.body.message));var n=r.body.result||r.body.user;t(n)})})},updateUser:function(n,t){return new Promise(function(i,o){return 0==helper.validateSiteId(e)?void o(new Error("Please Set Your TURBO_APP_ID")):null==t?void o(new Error("Updated parameters required.")):void superagent.put(r.base_url+"/api/user/"+n).send(t).set(helper.standardHeaders(e)).end(function(e,r){if(e)return void o(e);if("success"!=r.body.confirmation)return void o(new Error(r.body.message));var n=r.body.result||r.body.user;i(n)})})},deleteUser:function(n){return new Promise(function(t,i){if(0==helper.validateSiteId(e))return void i(new Error("Please Set Your TURBO_APP_ID"));superagent.delete(r.base_url+"/api/user/"+n).set(helper.standardHeaders(e)).end(function(e,r){if(e)return void i(e);if("fail"==r.body.confirmation)return void i(new Error(r.body.message));var n=r.body.result||r.body.results;t(n)})})}}};module.exports=Auth;