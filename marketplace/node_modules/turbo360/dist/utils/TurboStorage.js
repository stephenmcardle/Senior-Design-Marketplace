var Promise=require("bluebird"),superagent=require("superagent"),helper=require("./Helper"),TurboStorage=function(e){var n=e;return{uploadFile:function(e){return new Promise(function(r,t){if(null==e)return void t(new Error("Missing file"));if(null==e.name)return void t(new Error("Missing file name"));if(null==e.type)return void t(new Error("Missing file type"));var i={site:n.site_id,exec:"upload-string",filename:e.name,filetype:e.type};superagent.post(n.base_url+"/functions").send(i).set("Content-Type","application/json").end(function(i,o){if(i)return void t(i);var s=o.body;if("success"!=s.confirmation)return void t(new Error(s.message));var u=s.result;if(-1==e.type.indexOf("image"))return void superagent.put(u).send(e).set("Content-Type",e.type).end(function(i,o){if(i)return void t(i);var u={site:n.site_id,name:e.name,type:e.type,size:e.size,url:"https://storage.turbo360.co/"+s.site.slug+"/"+e.name};superagent.post(n.turbo_url+"/api/blob").send(u).set("Accept","application/json").end(function(e,n){if(e)return void t(e);r(n.body)})});var a=superagent.post(u);a.attach("file",e),a.end(function(i,o){if(i)return void t(i);var s=o.body.image,u={site:n.site_id,name:e.name,type:e.type,size:e.size,url:s.address};superagent.post(n.turbo_url+"/api/blob").send(u).set("Accept","application/json").end(function(e,n){if(e)return void t(e);r(n.body)})})})})}}};module.exports=TurboStorage;