"use strict";var fs=require("fs"),Promise=require("bluebird"),Mustache=require("mustache"),path=require("path"),cookie=require("cookie"),sessions=require("client-sessions"),decode=require("urldecode"),SESSION_COOKIE_NAME="vertexSession",shouldClearSession=!1,proxyVertexSession=function(e,r){var n={set:function(n,s,t){n==e&&(r.vertexSessionChanged=!0,n[s]=t)}};return new Proxy(e,n)},readFile=function(e){return new Promise(function(r,n){fs.readFile(e,"utf8",function(s,t){if(s)return void n(new Error("File Not Found: "+e));r(t)})})},readDirectory=function(e){return new Promise(function(r,n){fs.readdir(e,function(e,s){if(e)return void n(e);r(s)})})},renderMustache=function(e){return new Promise(function(r,n){var s=e.template;if(null==s)return void n(new Error("Missing template"));var t=e.data;if(null==t)return void n(new Error("Missing data"));var o=e.partials||{};try{var i=t||{};r(Mustache.render(s,i,o))}catch(e){n(e)}})},setVertexSession=function(e,r){if(1==shouldClearSession)return r["Set-Cookie"]=SESSION_COOKIE_NAME+"=deleted; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",shouldClearSession=!1,r;if(0==e.vertexSessionChanged)return r;var n=e.vertexSession||{};if(delete n.reset,0==Object.keys(n).length)return r;var s=JSON.stringify(n),t=sessions.util.encode({cookieName:SESSION_COOKIE_NAME,secret:"abc"},s,null,null);return r["Set-Cookie"]=SESSION_COOKIE_NAME+"="+t+"; path=/;",r},configureResponse=function(e,r){return{json:function(n){var s={"Content-Type":"application/json"};r(null,{isBase64Encoded:!1,statusCode:200,headers:setVertexSession(e,s),headers:s,body:JSON.stringify(n)})},send:function(n){var s={"Content-Type":"text/plain"};r(null,{isBase64Encoded:!1,statusCode:200,headers:setVertexSession(e,s),headers:s,body:n})},redirect:function(n){var s={Location:n};r(null,{isBase64Encoded:!1,statusCode:301,headers:setVertexSession(e,s),headers:s,body:n})},render:function(n,s){var t=s||{},o=__dirname.replace("node_modules/vertex360/dist/vertex",""),i=o+"/views/"+n+".mustache",a={},n=null;readFile(i).then(function(e){return n=e,readDirectory(o+"/views/partials")}).then(function(e){return e.forEach(function(e,r){e.indexOf(".mustache")>-1&&(a[e.split(".")[0]]=fs.readFileSync(o+"/views/partials/"+e,"utf8"))}),renderMustache({template:n,data:t,partials:a})}).then(function(n){r(null,{isBase64Encoded:!1,statusCode:200,headers:setVertexSession(e,{"Content-Type":"text/html"}),body:n})}).catch(function(e){r(null,{isBase64Encoded:!1,statusCode:404,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",message:e.message})})})}}},clearSession=function(){shouldClearSession=!0};module.exports=function(e,r,n){var s={};if(null!=e.body)try{s=JSON.parse(e.body)}catch(r){var t=e.body.split("&");t.forEach(function(e,r){var n=e.split("=");2==n.length&&(s[n[0]]=decode(n[1]))})}var o={query:e.queryStringParameters||{},body:s,headers:e.headers,vertexSessionChanged:!1},i={reset:clearSession};o.vertexSession=proxyVertexSession(i,o),null!=n&&(o.params=n.params);var a=e.headers.Cookie;if(null==a)return{req:o,res:configureResponse(o,r)};var u=cookie.parse(a);if(null==u.vertexSession)return{req:o,res:configureResponse(o,r)};try{var c=sessions.util.decode({cookieName:SESSION_COOKIE_NAME,secret:"abc"},u.vertexSession);if(null==c)return{req:o,res:configureResponse(o,r)};if(null==c.content)return{req:o,res:configureResponse(o,r)};var i=JSON.parse(c.content);return i.reset=clearSession,o[SESSION_COOKIE_NAME]=proxyVertexSession(i,o),{req:o,res:configureResponse(o,r)}}catch(e){return o[SESSION_COOKIE_NAME]=u.vertexSession,{req:o,res:configureResponse(o,r)}}};